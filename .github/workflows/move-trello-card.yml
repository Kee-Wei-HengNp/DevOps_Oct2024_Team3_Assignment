name: Move Trello Card on Feature Branch Creation

on:
  create:
    branches:
      - "feature/*"

jobs:
  move-card:
    runs-on: ubuntu-latest
    steps:
      - name: Extract Branch Name
        id: extract_branch
        run: |
          BRANCH_NAME=$(echo "${GITHUB_REF#refs/heads/}" | sed 's/feature\///' | sed 's/-/ /g')
          echo "üîπ Extracted Branch Name: $BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Find Trello Card ID
        id: find_card
        run: |
          API_URL="https://api.trello.com/1/search"
          echo "üîç Searching Trello for card matching branch name: $API_URL"

          RESPONSE=$(curl -s -G --data-urlencode "query=${{ env.BRANCH_NAME }}" --data "modelTypes=cards&key=${{ secrets.TRELLO_API_KEY }}&token=${{ secrets.TRELLO_TOKEN }}" "$API_URL")
          echo "üìÑ Trello API Response: $RESPONSE"

          CARD_ID=$(echo "$RESPONSE" | jq -r '.cards[0].id')

          if [[ -z "$CARD_ID" || "$CARD_ID" == "null" ]]; then
            echo "‚ùå No matching Trello card found for branch: ${{ env.BRANCH_NAME }}"
            exit 1
          fi

          echo "‚úÖ Found Trello Card ID: $CARD_ID"
          echo "CARD_ID=$CARD_ID" >> $GITHUB_ENV

      - name: Move Trello Card to "In Development"
        if: env.CARD_ID != ''
        run: |
          MOVE_URL="https://api.trello.com/1/cards/${{ env.CARD_ID }}/idList"
          echo "üîÑ Moving Trello Card to 'In Development' using API: $MOVE_URL"

          RESPONSE=$(curl -s -X PUT "$MOVE_URL" \
          -H "Content-Type: application/json" \
          --data "{\"idList\": \"${{ secrets.TRELLO_IN_DEVELOPMENT_LIST_ID }}\", \"key\": \"${{ secrets.TRELLO_API_KEY }}\", \"token\": \"${{ secrets.TRELLO_TOKEN }}\"}")

          echo "üìÑ Trello Move API Response: $RESPONSE"

          if [[ "$RESPONSE" == *"error"* ]]; then
            echo "‚ùå Error occurred while moving Trello card!"
            exit 1
          fi

          echo "‚úÖ Trello card successfully moved!"


