<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
    <div class="container">
        <h1>Admin Dashboard</h1>
        <h2>Manage Students</h2>

        <!-- ✅ Add Student Form -->
        <div class="form-container">
            <input type="text" id="new-username" placeholder="New Student Username" required>
            <input type="password" id="new-password" placeholder="Password" required>
            <button onclick="addStudent()">Add Student</button>
            <p id="add-student-message"></p>
        </div>

        <!-- ✅ Student List -->
        <table>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Actions</th>
            </tr>
            {% for student in students %}
            <tr>
                <td>{{ student[0] }}</td>
                <td contenteditable="true" class="edit-username">{{ student[1] }}</td>
                <td class="actions">
                    <button class="update-btn" onclick="updateStudent({{ student[0] }}, this)">Update</button>
                    <button class="delete-btn" onclick="deleteStudent({{ student[0] }})">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </table>

        <!-- ✅ Logout Button -->
        <div class="logout-container">
            <button class="logout-button" onclick="logout()">Logout</button>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>

</html>


<script>
    async function addStudent() {
        let username = document.getElementById('new-username').value;
        let password = document.getElementById('new-password').value;

        if (!username || !password) {
            alert("Username and password are required!");
            return;
        }

        let response = await fetch('/add_student', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        let result = await response.json();
        alert(result.message);
        if (result.success) location.reload();
    }

    async function updateStudent(studentId, button) {
        let row = button.closest("tr");
        let newUsername = row.querySelector(".edit-username").textContent.trim();
        let newPassword = prompt("Enter new password:");

        if (!newUsername || !newPassword) {
            alert("Both username and password are required!");
            return;
        }

        try {
            let response = await fetch('/update-student', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: studentId, username: newUsername, password: newPassword })
            });

            let result = await response.json();

            if (result.success) {
                alert(result.message || "Student updated successfully!");
                location.reload();  // Refresh page after update
            } else {
                alert(result.message || "Failed to update student.");
            }
        } catch (error) {
            alert("An unexpected error occurred: " + error.message);
        }
    }

    async function deleteStudent(studentId) {
        if (!confirm("Are you sure you want to delete this student?")) return;

        try {
            let response = await fetch('/delete-student', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: studentId })
            });

            if (!response.ok) {
                throw new Error("Failed to delete student.");
            }

            let result = await response.json();

            // ✅ Ensure message exists before showing alert
            if (result.success) {
                alert(result.message || "Student deleted successfully!");
                location.reload();  // Refresh page after deletion
            } else {
                alert(result.message || "Error deleting student.");
            }

        } catch (error) {
            alert("An unexpected error occurred: " + error.message);
        }
    }

    async function logout() {
        let response = await fetch('/logout');
        if (response.ok) {
            window.location.href = "/";
        }
    }

</script>
</body>

</html>